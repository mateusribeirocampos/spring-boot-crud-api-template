name: Supabase Keep-Alive Ping

on:
  schedule:
    # Executa a cada 6 horas (√†s 00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Permite executar manualmente

jobs:
  ping-supabase:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase Database
        run: |
          echo "üîÑ Iniciando ping no Supabase..."
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Faz uma requisi√ß√£o simples √† API REST
          response=$(curl -s -w "\n%{http_code}" \
                -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
                -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
                "https://mstadxawqnnwhvfezfbd.supabase.co/rest/v1/")
          
          # Separa o corpo da resposta e o c√≥digo HTTP
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "üìä Status HTTP: $http_code"
          
          # Verifica se a resposta foi bem-sucedida
          if [[ "$http_code" =~ ^2[0-9][0-9]$ ]]; then
            echo "‚úÖ Supabase est√° ativo e respondendo!"
            echo "Resposta: $body"
          else
            echo "‚ö†Ô∏è Resposta inesperada (c√≥digo $http_code)"
            echo "Resposta: $body"
            # N√£o falha o job, apenas registra
          fi

      - name: Ping espec√≠fico na tabela tb_users
        run: |
          echo "üîç Testando acesso √† tabela tb_users..."
          
          # Tenta fazer um SELECT simples (apenas contagem)
          response=$(curl -s -w "\n%{http_code}" \
                -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
                -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
                "https://mstadxawqnnwhvfezfbd.supabase.co/rest/v1/tb_user?select=count")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "üìä Status HTTP: $http_code"
          
          case $http_code in
            200)
              echo "‚úÖ Tabela tb_users acess√≠vel!"
              echo "Resposta: $body"
              ;;
            401)
              echo "üîí Tabela protegida por RLS (normal para seguran√ßa)"
              echo "O ping foi registrado mesmo assim!"
              ;;
            *)
              echo "‚ö†Ô∏è Resposta: $http_code"
              echo "Body: $body"
              ;;
          esac

      - name: Resumo do Ping
        run: |
          echo "üìã ================================"
          echo "‚úÖ Ping conclu√≠do com sucesso!"
          echo "üïê Pr√≥ximo ping em ~6 horas"
          echo "üìÖ Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "================================"